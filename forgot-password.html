<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - User Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Styles.css">
</head>
<body class="split-layout">

    <!-- LEFT SIDE - INFO PANEL -->
    <div class="info-panel">
        <div class="info-logo">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
            </svg>
        </div>
        <h1 class="info-title">Reset Password</h1>
        <p class="info-subtitle">Follow the steps to regain access</p>
    </div>

    <!-- RIGHT SIDE - FORM CONTAINER -->
    <div class="form-container">
        <div class="glass-card">
            <!-- STEP 1: Enter Email -->
            <div id="step-1">
                <h1 class="card-title">Forgot Password</h1>
                <p class="card-subtitle">Enter your email to get started</p>
                
                <div class="form">
                    <div id="step1-message" class="message error hidden"></div>
                    
                    <div class="form-group">
                        <input id="reset-email" type="email" class="form-input" placeholder=" " required>
                        <label for="reset-email" class="form-label">Your Email Address</label>
                    </div>
                    
                    <button type="button" id="verify-email-btn" class="btn btn-primary">
                        Continue
                    </button>
                    
                    <p class="form-link">
                        <a href="login.html" style="color: var(--accent);">← Back to Login</a>
                    </p>
                </div>
            </div>
            
            <!-- STEP 2: Reset Password -->
            <div id="step-2" class="hidden">
                <h1 class="card-title">Reset Your Password</h1>
                <p class="card-subtitle">Email: <span id="verified-email" style="color: var(--accent);"></span></p>
                
                <form id="reset-password-form" class="form">
                    <div id="step2-message" class="message error hidden"></div>
                    
                    <div class="form-group">
                        <input id="current-password" type="password" class="form-input" placeholder=" " required>
                        <label for="current-password" class="form-label">Current Password</label>
                    </div>
                    
                    <div class="form-group">
                        <input id="new-password" type="password" class="form-input" placeholder=" " required minlength="6">
                        <label for="new-password" class="form-label">New Password</label>
                    </div>
                    
                    <div class="form-group">
                        <input id="confirm-new-password" type="password" class="form-input" placeholder=" " required minlength="6">
                        <label for="confirm-new-password" class="form-label">Confirm New Password</label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        Reset Password
                    </button>
                    
                    <button type="button" id="back-to-step1" class="btn btn-secondary" style="margin-top: 0.75rem; background: transparent; border-color: var(--text-secondary); color: var(--text-secondary);">
                        Back
                    </button>
                </form>
            </div>

            <!-- STEP 3: Success Message -->
            <div id="step-3" class="hidden" style="text-align: center;">
                <div class="info-logo" style="margin: 0 auto 1.5rem;">
                    <svg width="50" height="50" fill="none" stroke="white" viewBox="0 0 24 24" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                
                <h2 class="card-title" style="margin-bottom: 1rem;">Success!</h2>
                <p class="card-subtitle" style="margin-bottom: 2rem;">Your password has been reset successfully.</p>
                
                <a href="login.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                    Go to Login
                </a>
            </div>
        </div>
    </div>

    <script>
        let currentUserEmail = null;

        document.getElementById('verify-email-btn').addEventListener('click', async () => {
            const email = document.getElementById('reset-email').value.trim();
            const messageEl = document.getElementById('step1-message');
            
            if (!email) {
                messageEl.textContent = '❌ Please enter your email address.';
                messageEl.classList.remove('hidden');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'verify_email');
                formData.append('email', email);
                
                const response = await fetch('api/forgot-password.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUserEmail = email;
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-2').classList.remove('hidden');
                    document.getElementById('verified-email').textContent = email;
                } else {
                    messageEl.textContent = '❌ ' + data.message;
                    messageEl.classList.remove('hidden');
                    
                    setTimeout(() => {
                        messageEl.classList.add('hidden');
                    }, 4000);
                }
            } catch (error) {
                console.error('Error:', error);
                messageEl.textContent = '❌ Connection error. Please try again.';
                messageEl.classList.remove('hidden');
            }
        });

        document.getElementById('back-to-step1').addEventListener('click', () => {
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('reset-email').value = '';
            currentUserEmail = null;
        });

        document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const messageEl = document.getElementById('step2-message');
            
            if (newPassword !== confirmPassword) {
                messageEl.textContent = '❌ New passwords do not match.';
                messageEl.classList.remove('hidden');
                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 4000);
                return;
            }
            
            if (currentPassword === newPassword) {
                messageEl.textContent = '❌ New password must be different from current password.';
                messageEl.classList.remove('hidden');
                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 4000);
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'reset_password');
                formData.append('email', currentUserEmail);
                formData.append('current_password', currentPassword);
                formData.append('new_password', newPassword);
                
                const response = await fetch('api/forgot-password.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('step-2').classList.add('hidden');
                    document.getElementById('step-3').classList.remove('hidden');
                } else {
                    messageEl.textContent = '❌ ' + data.message;
                    messageEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                messageEl.textContent = '❌ An error occurred. Please try again.';
                messageEl.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
